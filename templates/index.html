<!DOCTYPE html>
<html lang="nn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Stadthavet AIS Sporing</title>

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="manifest" href="/static/site.webmanifest">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4M8L3DXLD8"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4M8L3DXLD8');
    </script>

    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:title" content="Stadthavet AIS Sporing - Skipstrafikk over Stad" />
    <meta property="og:description" content="Sporing av skipstrafikk som passerer Stad-halvÃ¸ya. Viser kryssingar, ventehendingar og vÃªrforhold basert pÃ¥ AIS-data frÃ¥ Barentswatch og vinddata frÃ¥ met.no." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://stad.bringsvor.com" />
    <meta property="og:image" content="https://stad.bringsvor.com/static/og-image.png" />
    <meta name="description" content="Sporing av skipstrafikk som passerer Stad-halvÃ¸ya. Viser kryssingar, ventehendingar og vÃªrforhold." />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Stadthavet AIS Sporing" />
    <meta name="twitter:description" content="Sporing av skipstrafikk som passerer Stad-halvÃ¸ya. Viser kryssingar, ventehendingar og vÃªrforhold." />
    <meta name="twitter:image" content="https://stad.bringsvor.com/static/og-image.png" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="{{ url_for('static', filename='js/i18n.js') }}"></script>
    <div class="header">
        <div class="header-content">
            <div>
                <h1 id="header-title">ğŸŒŠ Stadthavet AIS Sporing</h1>
                <p id="header-subtitle">Sanntidsovervaking av skipstrafikk over Stad-halvÃ¸ya</p>
            </div>
            <div class="header-right">
                <div class="nav-links">
                    <div class="dropdown">
                        <button class="nav-link dropdown-btn" data-i18n="webcams.title">Webcams</button>
                        <div class="dropdown-content">
                            <a href="https://www.sandsoyveret.com" target="_blank" rel="noopener">ğŸ“¹ SandsÃ¸y</a>
                            <a href="https://www.seljeseth.com/larsnes/weather/" target="_blank" rel="noopener">ğŸ“¹ Larsnes</a>
                            <a href="https://www.skylinewebcams.com/webcam/norge/western-norway/stad/vestkapp.html" target="_blank" rel="noopener">ğŸ“¹ Vestkapp</a>
                            <a href="https://www.skylinewebcams.com/en/webcam/norge/western-norway/maloy/maloy.html" target="_blank" rel="noopener">ğŸ“¹ MÃ¥lÃ¸y</a>
                        </div>
                    </div>
                    <button class="nav-link" id="stats-btn" data-i18n="nav.statistics">ğŸ“Š Statistikk</button>
                    <a href="/about" class="nav-link" data-i18n="nav.about">Om oss</a>
                </div>
                <div class="header-status" id="last-updated">
                    <div data-i18n="status.lastUpdated">Sist oppdatert:</div>
                    <div id="update-time">-</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-ships">-</div>
                    <div class="stat-label" data-i18n="stats.totalShips">Skip totalt</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-crossings">-</div>
                    <div class="stat-label" data-i18n="stats.crossings">Kryssingar</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-waiting">-</div>
                    <div class="stat-label" data-i18n="stats.waitingEvents">Ventehendingar</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-recent">-</div>
                    <div class="stat-label" data-i18n="stats.last24h">Siste 24t</div>
                </div>
            </div>

            <h3 class="section-title" data-i18n="sections.recentCrossings">Siste kryssingar</h3>
            <p class="info-text" data-i18n="info.clickToView">Klikk pÃ¥ eit skip for Ã¥ sjÃ¥ det i kartet</p>
            <div class="event-list" id="crossings-list">
                <div class="loading" data-i18n="loading.crossings">Lastar kryssingar...</div>
            </div>

            <h3 class="section-title" data-i18n="sections.waitingEvents">Ventehendingar</h3>
            <div class="event-list" id="waiting-list">
                <div class="loading" data-i18n="loading.waiting">Lastar ventehendingar...</div>
            </div>

            <h3 class="section-title" data-i18n="weather.current">Aktuelt vÃªr (MÃ¥lÃ¸y)</h3>
            <div class="stat-card" id="weather-card">
                <div class="loading" data-i18n="weather.noData">Ingen vÃ¦rdata tilgjengeleg</div>
            </div>

            <h3 class="section-title" data-i18n="legend.title">Forklaring</h3>
            <div class="event-item legend-box">
                <div data-i18n="legend.crossingLine">Raud stipla linje = Stad-kryssingslinje</div>
                <div data-i18n="legend.eastZone">Gul sirkel = Austleg ventesone</div>
                <div data-i18n="legend.westZone">GrÃ¸n sirkel = Vestleg ventesone</div>
                <div data-i18n="legend.yellowDots">Gule prikkar = Kryssingar austâ†’vest</div>
                <div data-i18n="legend.greenDots">GrÃ¸ne prikkar = Kryssingar vestâ†’aust</div>
                <div data-i18n="legend.info">Systemet sporer skip som kryssar Stad-halvÃ¸ya og identifiserer skip som ventar i opne farvatn nÃ¥r vinden er >10 m/s. Data blir samla kvar 12. time for Ã¥ byggje opp historikk over tid.</div>
            </div>
        </div>

        <div class="main-content">
            <div id="map"></div>
            <div class="charts">
                <div class="chart-container">
                    <h3 data-i18n="sections.crossingsVsWind">Daglige kryssingar vs vindstyrke</h3>
                    <canvas id="crossings-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 data-i18n="sections.weatherConditions">VÃ¦rforhold</h3>
                    <canvas id="weather-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>

    <!-- Statistics Modal -->
    <div id="stats-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-i18n="stats.modalTitle">ğŸ“Š Statistikk</h2>
                <button id="stats-close" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="stats-summary">
                    <div class="stat-item">
                        <div class="stat-value" id="modal-total-ships">-</div>
                        <div class="stat-label" data-i18n="stats.totalShips">Skip totalt</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="modal-total-crossings">-</div>
                        <div class="stat-label" data-i18n="stats.crossings">Kryssingar</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="modal-recent-24h">-</div>
                        <div class="stat-label" data-i18n="stats.last24h">Siste 24t</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="modal-total-positions">-</div>
                        <div class="stat-label" data-i18n="stats.positions">Posisjonar</div>
                    </div>
                </div>

                <h3>ğŸ“ Skipsstorleik</h3>
                <div class="stats-summary">
                    <div class="stat-item">
                        <div class="stat-value" id="modal-ships-over-50">-</div>
                        <div class="stat-label">Skip â‰¥ 50m</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="modal-ships-under-50">-</div>
                        <div class="stat-label">Skip < 50m</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="modal-ships-unknown">-</div>
                        <div class="stat-label">Ukjent lengde</div>
                    </div>
                </div>

                <h3>ğŸ“Š Kryssingar etter storleik</h3>
                <div class="stats-summary">
                    <div class="stat-item">
                        <div class="stat-value" id="modal-crossings-over-50">-</div>
                        <div class="stat-label">â‰¥ 50m</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="modal-crossings-under-50">-</div>
                        <div class="stat-label">< 50m</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="modal-crossings-unknown">-</div>
                        <div class="stat-label">Ukjent</div>
                    </div>
                </div>

                <h3 data-i18n="stats.topShips">ğŸ† Topp 10 skip etter kryssingar</h3>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th data-i18n="table.shipName">Namn</th>
                            <th data-i18n="table.shipType">Type</th>
                            <th>Lengde</th>
                            <th data-i18n="table.crossings">Kryssingar</th>
                        </tr>
                    </thead>
                    <tbody id="top-ships-tbody">
                        <tr><td colspan="5"><span data-i18n="loading.stats">Lastar...</span></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Statistics modal functionality
        const statsBtn = document.getElementById('stats-btn');
        const statsModal = document.getElementById('stats-modal');
        const statsClose = document.getElementById('stats-close');

        statsBtn.addEventListener('click', () => {
            loadStatsModal();
            statsModal.style.display = 'flex';
        });

        statsClose.addEventListener('click', () => {
            statsModal.style.display = 'none';
        });

        statsModal.addEventListener('click', (e) => {
            if (e.target === statsModal) {
                statsModal.style.display = 'none';
            }
        });

        async function loadStatsModal() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                // Update total stats
                document.getElementById('modal-total-ships').textContent = data.total_ships;
                document.getElementById('modal-total-crossings').textContent = data.total_crossings;
                document.getElementById('modal-recent-24h').textContent = data.recent_crossings_24h;
                document.getElementById('modal-total-positions').textContent = data.total_positions.toLocaleString();

                // Update ship size stats
                if (data.ships_by_size) {
                    document.getElementById('modal-ships-over-50').textContent = data.ships_by_size.over_50m || 0;
                    document.getElementById('modal-ships-under-50').textContent = data.ships_by_size.under_50m || 0;

                    const shipsUnknownElem = document.getElementById('modal-ships-unknown');
                    const shipsUnknown = data.ships_by_size.unknown || 0;
                    shipsUnknownElem.textContent = shipsUnknown;
                    // Hide unknown box if 0
                    shipsUnknownElem.parentElement.style.display = shipsUnknown === 0 ? 'none' : 'block';
                }
                if (data.crossings_by_size) {
                    document.getElementById('modal-crossings-over-50').textContent = data.crossings_by_size.over_50m || 0;
                    document.getElementById('modal-crossings-under-50').textContent = data.crossings_by_size.under_50m || 0;

                    const crossingsUnknownElem = document.getElementById('modal-crossings-unknown');
                    const crossingsUnknown = data.crossings_by_size.unknown || 0;
                    crossingsUnknownElem.textContent = crossingsUnknown;
                    // Hide unknown box if 0
                    crossingsUnknownElem.parentElement.style.display = crossingsUnknown === 0 ? 'none' : 'block';
                }

                // Update top 10 ships table
                const tbody = document.getElementById('top-ships-tbody');
                tbody.innerHTML = '';

                data.top_ships_by_crossings.forEach((ship, index) => {
                    const row = document.createElement('tr');
                    const lengthText = ship.length ? `${ship.length}m` : '-';
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${ship.name}</td>
                        <td>${ship.ship_type || '-'}</td>
                        <td>${lengthText}</td>
                        <td>${ship.crossings}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }
    </script>

</body>
</html>
